#!/bin/bash

export APPROOT=${1-.}
export APPUSER=${2-$USER}
export APPHOME=${3-$HOME}

function topic {
  echo ""
  echo ">> ${@}"
}

function run {
  echo "> Run: ${@}"
  $@
}

topic "Update the apt cache"
run sudo apt-get update

topic "Instal ruby and configure rubygem"
run sudo DEBIAN_FRONTEND=noninteractive \
    apt-get install --quiet --assume-yes ruby2.0
run sudo update-alternatives --install /usr/bin/ruby ruby /usr/bin/ruby2.0 1
run sudo update-alternatives --install /usr/bin/gem gem /usr/bin/gem2.0 1

topic "Install foreman and bundler gems"
run sudo gem install --quiet --no-ri --no-rdoc bundler foreman

topic "Install system dependencies (Ruby on Rails)"
run sudo DEBIAN_FRONTEND=noninteractive \
    apt-get install --quiet --assume-yes zlib1g-dev

topic "Install system dependencies (Database)"
run sudo DEBIAN_FRONTEND=noninteractive \
    apt-get install --quiet --assume-yes libsqlite3-dev

topic "Install system dependencies (Gems)"
run sudo DEBIAN_FRONTEND=noninteractive \
    apt-get install --quiet --assume-yes build-essential ruby2.0-dev

topic "Install gems dependencies"
cd $APPROOT && run bundle install --path vendor/bundle --binstubs $APPHOME/bin

topic "Initialize the database"
cd $APPROOT && run bin/rake db:schema:load
